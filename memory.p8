pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
game_screen={
	board={},
	hover=nil,
	row=1,
	col=1,
	open={},
	correct={},
	clear_open=0,
	score=0,
	wrong_moves=0,
	moves=0
}

function make_card(num,c)
	sp={
		[1]=64,
		[2]=66,
		[3]=68,
		[4]=70,
		[5]=72,
		[6]=74,
		[7]=76,
		[8]=78
	}
	local card={
		num=num,
		c=c,
		sp=sp[num]
	}
	return card
end

function game_screen:card_at(row,col)
	for i=1,4 do
		for j=1,4 do
			if i==row and j==col then
				return self.board[row][col]
			end
		end
	end
end

function game_screen:open_card()
	if #self.open==2 then
		return
	end
	
	-- is open already?
	for _,card in pairs(self.correct) do
		if card==self.hover then
			return
		end
	end
	
	add(self.open, self.hover)

	if #self.open==2 then
		self.moves+=1
		if self.open[1].num==self.open[2].num then
			self.score+=1
			sfx(2)
			add(self.correct,self.open[1])
			add(self.correct,self.open[2])
		else
			sfx(0)
			self.wrong_moves+=1
		end
		
		self.clear_open=time()
	end
end

function game_screen:is_hover(row,col)
	return self:card_at(row,col) == self.hover
end

function game_screen:is_open(row,col)
	c = self:card_at(row,col)
	
	for _,card in pairs(self.correct) do
		if card==c then
			return true
		end
	end
	
	for _,card in pairs(self.open) do
		if card==c then
			return true
		end
	end
	return false
end

function game_screen:reset()
	values={1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8}
	self.board={{},{},{},{}}
	for row=1,4 do
		for col=1,4 do
			index=flr(rnd(#values))+1
			num=values[index]
			self.board[row][col]=make_card(num,num)
			deli(values,index)
		end
	end
	self.moves=0
	self.wrong_moves=0
	self.score=0
	self.row=1
	self.col=1
	self.hover=self.board[1][1]
end

function game_screen:draw()
	local cell_w=29
	local cell_h=27
	local cell_hw=cell_w\2-1
	local cell_hh=cell_h\2-1
	local mleft=5 -- margin left
	local mtop=15 -- margin top
	
	rectfill(0,0,127,127,7)
	for row=1,4 do
		for col=1,4 do
			local card=self.board[row][col]
			local w=cell_w
			local h=cell_h
			local x=(col-1)*w+mleft
			local y=(row-1)*h+mtop
			local x1=x+w
			local y1=y+h

			rect(x,y,x1,y1,13)
			if self:is_open(row,col) then
				--rectfill(x+1,y+1,x1-1,y1-1,card.c)
				print(card.num,x+cell_hw,y+cell_hh,7)
				spr(card.sp,x+6,y+5,2,2)
			end
		end
	end
	
	map()
	
	-- cursor
	local x=(self.col-1)*cell_w+mleft
	local y=(self.row-1)*cell_h+mtop
	local x1=x+cell_w
	local y1=y+cell_h
	rect(x,y,x1,y1,8)
	
	-- hud
	print("score:"..self.score,5,3,2)
	print("moves:"..self.moves,48,3,2)
	print("wrong:"..self.wrong_moves,90,3,2)
end

function game_screen:update_inputs()
	local did_move=false
	if btnp(❎) then
		self:open_card()
	end
	
	if btnp(➡️) then
		self.col+=1
		did_move=true
	end
	if btnp(⬅️) then
		self.col-=1
		did_move=true
	end
	if btnp(⬆️) then
		self.row-=1
		did_move=true
	end
	if btnp(⬇️) then
		self.row+=1
		did_move=true
	end
	
	if self.col<1 then
		self.col=1
	end
	
	if self.col>4 then
		self.col=4
	end
	
	if self.row<1 then
		self.row=1
	end
	
	if self.row>4 then
		self.row=4
	end
	
	if did_move then
		self.hover=self:card_at(self.row,self.col)
		sfx(1)
	end
end

function game_screen:update()
	self:update_inputs()
	
	if self.clear_open>0 and time()-self.clear_open>1 then
		self.open={}
		self.clear_open=0
	end
end

function _init()
	current_screen=game_screen
	current_screen:reset()
end

function _update()
	current_screen:update()
end

function _draw()
	cls()
	current_screen:draw()
end
__gfx__
00000000a2ba100000000000a2ba10000021ab2a004a2ba100000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000041d790000000000041d7900000197d1400641d7900000000000000000000000000000000000000000000000000000000000000000000000000000000
007007009d982000000000009d982000003289d90019d982eb732fa77af237beeb732fa700000000000000000000000000000000000000000000000000000000
00077000b83de00000000000b83de00000bed38b008b83de2f6b85e66e58b6f22f6b85e600000000000000000000000000000000000000000000000000000000
00077000691ca00028fae291691caefddfeac196004691caace1f398893f1ecaace1f39800000000000000000000000000000000000000000000000000000000
00700700ace1f0003b1cd87aace1f398893f1eca007ace1f691caefddfeac196691caefd00000000000000000000000000000000000000000000000000000000
000000002f6b800076e139db2f6b85e66e58b6f200d2f6b8b83de100001ed38bb83de19e00000000000000000000000000000000000000000000000000000000
00000000eb732000bfc98d12eb732fa77af237be00aeb73239dcf20000c89a2d0000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00333000300003300333000300000330000000000003300000000003000000003330000000000330b00000000000000000000000000000000000000003333000
00000300303333000303333333333300000000000003000000000033000003303333000000033330bbbb88000000000000000000000000000000000033330000
000033333330000000008888888803000000000000033000000000030000330003333300003333000bb888800000000000000000000000000000000433000000
00333883388000000008888a88888300000000000903333300000003000030000033333333333000bb8888880000000000000bbbbbb000000000099999900000
03388888388880000088888888a88800000000009993003300000223333300000000000330000000b8888788000000000000bbbbbbbb00000000999999990000
03888888338888000088a88888888800000000009999000000002223330000000000022222200000888887788000000000bbbbbbbb7bbb000009999997779000
3888778883888880088888888888888000000009999993300000222233000000000022222212000088888877880000000bbbbbbbbb777bb00099999999779900
8887788888888888088a8888888888800000009979999030000002200220000000022222211120000888888888800000bbbbbbbbbbbb7bbb0099999999779900
88878888888888880888888a88888a800000099799990000000222222222000000022222211120000008888888800000bb3bbbbbbbbbbbbb0099999999979900
8877888888888888088888888a8888800000099999000000002222222222000000022222221220000000088888880000bb333bbbbbbbbbbb0099999999999900
8878888888888888008888888888880000009999900000000022222222200000000022222212000000000088888880000bbb333bbbbbbbb00099999999999900
888888888888888800088a8888888000000999900000000000022022000000000000022222200000000000008888880000bbb333bbbbbb000099999999999900
0888888888888880000888888888800000999900000000000000022220000000000000021000000000000000008888000000bbbbbbbb00000009999999999000
0088888888888800000888888a888000099900000000000000000222200000000000000211100000000000000008888000000bbbbbb000000000999999990000
00088888888880000000888888880000999000000000000000000022000000000000000222100000000000000000088800000000000000000000099999900000
00000888888000000000088888800000990000000000000000000000000000000000000002200000000000000000000800000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0608080808080808080808080808080700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0302020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0004000025150201501c150181501615013150111500f1500e1500c1500c1500a15005150021500a1000d1000e10010100111000c10000100081002f000000000000000000000000000000000000000000000000
00030000000000f070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000200001c7501b7501a7501a7501a7501b7501b7501b7501b7501a750197501875015750137500f7500d7500b750097500875009750097500b7500d7500f7501175013750147501575016750167501675015750
